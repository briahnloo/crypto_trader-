# Crypto MVP - Profit Optimized Configuration
# This configuration is optimized for maximum profit with controlled risk

# Trading Configuration
trading:
  timeframe: "1h"
  symbols:
    - "BTC/USDT"
    - "ETH/USDT"
    - "ADA/USDT"
    - "SOL/USDT"
  symbol_whitelist:
    - "BTC/USDT"
    - "ETH/USDT"
  strategies:
    - "momentum"
    - "breakout"
    - "arbitrage"
    - "sentiment"
    - "whale_tracking"
  max_open_trades: 5
  min_trade_interval: 300  # 5 minutes in seconds
  trade_timeout: 3600  # 1 hour in seconds
  min_confidence: 0.3  # Reduced from 0.4 to 0.3 for more opportunities
  min_signal_score: 0.10  # Reduced from 0.15 to 0.10 for more trades
  cycle_interval: 60  # Time between trading cycles in seconds (60 seconds)
  initial_capital: 10000  # Starting capital for trading
  live_mode: false  # Live trading mode (false for paper trading)
  dry_run: false  # Dry run mode (false to allow simulated trades)
  ohlcv_limit: 100  # Number of OHLCV candles to fetch

# Risk Management Configuration
risk:
  max_drawdown: 0.10  # 10% maximum drawdown
  stop_loss: 0.02  # 2% stop loss
  take_profit: 0.04  # 4% take profit
  position_sizing:
    method: "risk_based"  # risk_based, fixed_risk, fixed_size, kelly_criterion
    risk_per_trade_pct: 0.25  # 0.25% of equity per trade
    max_notional_pct: 1.0  # 1.0% max notional of equity
    risk_per_trade: 0.01  # 1% risk per trade (legacy)
    max_position_size: 0.1  # 10% max position size (legacy)
  daily_loss_limit: 0.05  # 5% daily loss limit (enhanced for safety)
  max_drawdown_limit: 0.10  # 10% maximum drawdown limit
  position_size_limit: 0.02  # 2% maximum position size limit
  stop_loss_percentage: 0.03  # 3% automatic stop loss percentage
  max_risk_per_trade: 0.02  # 2% maximum risk per trade
  max_correlation: 0.7  # Maximum correlation between positions
  volatility_adjustment: true
  dynamic_sizing: true
  
  # SL/TP derivation configuration
  sl_tp:
    atr_mult_sl: 1.2          # ATR multiplier for stop loss
    atr_mult_tp: 2.0          # ATR multiplier for take profit
    fallback_pct_sl: 0.02     # 2% fallback stop loss
    fallback_pct_tp: 0.04     # 4% fallback take profit
    min_sl_abs: 0.001         # absolute guardrail for small-price assets
    min_tp_abs: 0.002         # absolute guardrail for small-price assets
  
  # Risk-Reward and fallback configuration
  enable_percent_fallback: true  # Enable percent-based SL/TP when ATR fails
  rr_min: 1.30                   # Minimum risk-reward ratio for regular trades
  rr_relax_for_pilot: 1.60       # Risk-reward ratio threshold for pilot trades
  
  # OCO (One-Cancels-Other) order management
  oco_enabled: true              # Enable OCO orders after fills
  tp_atr: 0.7                    # Take profit at 0.7 * ATR
  sl_atr: 0.5                    # Stop loss at 0.5 * ATR
  time_stop_minutes: 30          # Time stop: exit after 30 minutes if no TP/SL hit
  trail_after_atr: 1.0           # Start trailing TP after +1 ATR in favor
  trail_step_atr: 0.3            # Trail TP by 0.3 * ATR steps
  
  # Stop-loss cooldown
  cooldown_after_sl_seconds: 180  # 5 minutes cooldown after stop-loss hit
  
  # Risk-per-trade sizing
  risk_per_trade_pct: 0.10       # Risk 0.10% of equity per trade
  allow_upsize: false            # Never increase position size beyond current default
  
  # Exit logic configuration
  exits:
    enable_chandelier: true
    chandelier_n_atr: 2.5
    tp_ladders:
      - { profit_pct: 0.8, pct: 0.50 }  # +0.8% profit, sell 50% of position
      - { profit_pct: 1.5, pct: 0.50 }  # +1.5% profit, sell 50% of remaining
    time_stop_bars: 60
    min_qty: 1e-9
  
  # Entry gate configuration
  entry_gate:
    enable_top_k: true          # NEW: Enable top-k selection instead of threshold
    top_k_entries: 2            # NEW: Try top 2 candidates (or 3)
    hard_floor_min: 0.60        # Increased from 0.40 for higher quality trades
    gate_margin: 0.05           # Increased from 0.01 for more flexibility
    effective_threshold: 0.65   # Keep as-is, used if enable_top_k=false
    enable_vol_gate_easing: true  # Enable volatility-aware easing
    vol_ease_k: 0.02           # Volatility easing coefficient
    vol_ease_max: 0.5          # Maximum volatility easing
  
  # Exploration budget for forced pilots in quiet markets
  exploration:
    enabled: true
    budget_pct_per_day: 0.03     # 3% of equity/day reserved for forced pilots
    min_score: 0.30              # Allow marginal setups in quiet regimes
    max_forced_per_day: 2        # Cap on forced trades per day
    size_mult_vs_normal: 0.5     # Half normal risk size
    tighter_stop_mult: 0.7       # 30% tighter stops than normal
  
  # Risk-on override for volatile market conditions
  risk_on:
    enabled: true
    trigger:
      atr_over_sma: 1.00         # ATR/ATR_SMA >= 1.00 triggers risk-on mode (lowered from 1.15)
      atr_period: 14             # ATR period
      atr_sma_period: 100        # ATR_SMA period
    window_cycles: 3             # Override lasts for next 3 cycles
    min_gate_floor: 0.35         # Lower than normal hard floor
    risk_per_trade_pct: 0.02     # Bump from default (1%->2%)
    allow_pyramids: true
    max_adds: 2
    add_triggers_r: [0.75, 1.5]  # Adds at +0.75R and +1.5R
  
  # Risk-based sizing configuration
  sizing:
    risk_per_trade_pct: 0.01   # 1% risk per trade (base, outside risk-on)
    max_position_value_pct: 0.05  # 5% max position value
    pilot_multiplier: 0.4      # Pilot trades use 40% of normal size
    min_clip_$: 10.0           # Minimum slice size in dollars
    per_symbol_cap_$: 500.0    # Per-symbol cap in dollars
    session_cap_$: 0.3         # Session cap as fraction of equity (30%)
  
  # Daily loss limit guardrail
  daily_max_loss_pct: 0.02       # Halt entries if daily loss > 2%
  
  # Preflight validation configuration
  min_stop_frac: 0.001           # Minimum stop distance as fraction of entry price (0.1%)
  fallback_stop_frac: 0.005      # Fallback stop distance as fraction of entry price (0.5%)
  short_enabled: false           # Global default - disable shorts on spot by default

# Live Trading Safeguards Configuration
live_trading_safeguards:
  # Paper trading mode - CRITICAL for testing
  paper_trading_mode: true  # Set to false only for live trading with real money
  paper_trading_balance: 10000  # Starting balance for paper trading
  
  # Emergency stop functionality
  emergency_stop:
    enabled: true
    manual_override: true  # Allow manual emergency stop
    auto_stop_triggers:
      - "max_drawdown_exceeded"
      - "daily_loss_limit_exceeded"
      - "position_size_limit_exceeded"
      - "api_connection_lost"
      - "unusual_activity_detected"
  
  # Position size limits for live trading
  position_limits:
    max_position_size_pct: 0.01  # 1% maximum position size for live trading
    max_total_exposure_pct: 0.05  # 5% maximum total exposure
    max_positions_count: 3  # Maximum number of open positions
    min_position_size_usd: 10  # Minimum position size in USD
    max_position_size_usd: 500  # Maximum position size in USD
  
  # Trading session limits
  session_limits:
    max_trading_hours: 8  # Maximum trading hours per day
    max_trades_per_day: 10  # Maximum trades per day
    max_trades_per_hour: 3  # Maximum trades per hour
    trading_start_time: "09:00"  # Trading start time (24h format)
    trading_end_time: "17:00"  # Trading end time (24h format)
    weekend_trading: false  # Allow trading on weekends
  
  # Real-time monitoring and alerts
  monitoring:
    enabled: true
    alert_thresholds:
      equity_change_pct: 2.0  # Alert if equity changes by more than 2% in one cycle
      position_pnl_pct: 5.0  # Alert if any position P&L exceeds 5%
      unusual_volume_multiplier: 3.0  # Alert if volume is 3x normal
      api_error_count: 5  # Alert if more than 5 API errors in 10 minutes
    
    # Alert destinations
    alerts:
      console: true  # Console alerts
      log_file: true  # Log file alerts
      email: false  # Email alerts (requires SMTP config)
      telegram: false  # Telegram alerts (requires bot token)
      discord: false  # Discord alerts (requires webhook)
  
  # Safety checks before live trading
  pre_live_checks:
    min_paper_trading_days: 7  # Minimum days of paper trading before live
    min_paper_trading_trades: 50  # Minimum paper trades before live
    max_paper_trading_loss_pct: 5.0  # Maximum paper trading loss allowed
    required_win_rate: 0.4  # Minimum win rate required (40%)
    required_profit_factor: 1.2  # Minimum profit factor required
  
  # Live trading confirmation
  live_trading_confirmation:
    require_confirmation: true  # Require explicit confirmation for live trading
    confirmation_timeout: 30  # Timeout in seconds for confirmation
    double_confirmation: true  # Require double confirmation for live trading
    confirmation_phrase: "I_UNDERSTAND_THE_RISKS"  # Phrase required for confirmation

# Universe Configuration
universe:
  whitelist: [BTC/USDT, ETH/USDT, ADA/USDT, SOL/USDT]  # Only trade these liquid pairs

# Symbol-specific Configuration
symbols:
  BTC/USDT:
    allow_short: false
  ETH/USDT:
    allow_short: false

  ADA/USDT:
    allow_short: false
  SOL/USDT:
    allow_short: false

# Market Data Configuration
market_data:
  max_spread_bps: 3              # Maximum spread in basis points (0.03%)
  max_quote_age_ms: 200          # Maximum quote age in milliseconds
  require_l2_mid: true           # Require top-of-book mid from same venue as execution

# Enhanced Logging Configuration
logging:
  enhanced_execution_logs: true   # Enable detailed trade metrics logging
  aggregation_interval: 50        # Print aggregated table every N trades
  include_regime_analysis: true   # Include regime analysis in logs

# Exchange Configuration
exchanges:
  binance:
    enabled: true
    api_key: "${BINANCE_API_KEY:-your_binance_api_key_here}"
    secret: "${BINANCE_SECRET:-your_binance_secret_here}"
    sandbox: true
    rate_limit: 10
    timeout: 30
    symbols:
      - "BTC/USDT"
      - "ETH/USDT"
      - "ADA/USDT"
      - "SOL/USDT"

  coinbase:
    enabled: true
    api_key: "${COINBASE_API_KEY:-your_coinbase_api_key_here}"
    secret: "${COINBASE_SECRET:-your_coinbase_secret_here}"
    sandbox: true
    rate_limit: 5
    timeout: 30
    symbols:
      - "BTC-USD"
      - "ETH-USD"

  ccxt:
    enabled: true
    exchanges:
      - "binance"
      - "coinbase"
    rate_limit: 5
    timeout: 30

# Data Sources Configuration
data_sources:
  # Market Data
  market_data:
    enabled: true
    sources:
      - "binance"
      - "coinbase"
    update_interval: 60  # seconds
    historical_days: 30

  # Technical Indicators
  technical_indicators:
    enabled: true
    indicators:
      - "rsi"
      - "macd"
      - "bollinger_bands"
      - "atr"
      - "stochastic"
      - "williams_r"
      - "cci"
      - "obv"
      - "ichimoku"
    lookback_periods: 100

  # Sentiment Analysis
  sentiment:
    enabled: true
    sources:
      social_media:
        enabled: true
        platforms:
          - "twitter"
          - "reddit"
        api_keys:
          twitter: "your_twitter_api_key_here"
          reddit: "your_reddit_api_key_here"
        update_interval: 300  # 5 minutes

      news:
        enabled: true
        sources:
          - "coindesk"
          - "decrypt"
          - "cointelegraph"
        api_keys:
          news_api: "your_news_api_key_here"
        update_interval: 600  # 10 minutes

      fear_greed:
        enabled: true
        api_key: "your_fear_greed_api_key_here"
        update_interval: 3600  # 1 hour

  # On-Chain Data
  on_chain:
    enabled: true
    sources:
      - "whale_alert"
      - "glassnode"
      - "blockchain_info"
    api_keys:
      whale_alert: "your_whale_alert_api_key_here"
      glassnode: "your_glassnode_api_key_here"
    update_interval: 1800  # 30 minutes
    min_whale_value: 1000000  # $1M minimum whale transaction

# Strategy Configuration
strategies:
  momentum:
    enabled: true
    weight: 0.30  # Increased from 0.25
    parameters:
      rsi_period: 14
      rsi_oversold: 25  # More aggressive from 30
      rsi_overbought: 75  # More aggressive from 70
      macd_fast: 12
      macd_slow: 26
      macd_signal: 9
      min_volume_ratio: 1.2  # Reduced from 1.5

  breakout:
    enabled: true
    weight: 0.25  # Increased from 0.20
    parameters:
      lookback_period: 20
      breakout_threshold: 0.015  # Reduced from 0.02 for more signals
      volume_confirmation: true
      min_volume_multiplier: 1.5  # Reduced from 2.0

  arbitrage:
    enabled: true
    weight: 0.20  # Increased from 0.15
    parameters:
      min_spread: 0.0005  # Reduced from 0.001 for more opportunities
      max_position_size: 0.05
      execution_timeout: 30
      slippage_tolerance: 0.0005

  sentiment:
    enabled: true
    weight: 0.15  # Reduced from 0.20
    parameters:
      sentiment_threshold: 0.4  # Reduced from 0.6 for more signals
      news_weight: 0.4
      social_weight: 0.3
      fear_greed_weight: 0.3
      min_confidence: 0.5  # Reduced from 0.7

  whale_tracking:
    enabled: true
    weight: 0.10  # Reduced from 0.20
    parameters:
      min_whale_value: 500000  # Reduced from 1000000
      impact_threshold: 0.005  # Reduced from 0.01
      time_window: 3600  # 1 hour
      confidence_threshold: 0.6  # Reduced from 0.8

# Signal Configuration
signals:
  generation:
    enabled: true
    update_interval: 60  # seconds
    min_confidence: 0.4  # Reduced from 0.6
    max_signals_per_symbol: 3

  filtering:
    enabled: true
    correlation_threshold: 0.7
    volatility_filter: true
    volume_filter: true
    time_filter: true

  execution:
    enabled: true
    delay: 5  # seconds delay before execution
    retry_attempts: 3
    retry_delay: 10  # seconds
  
  # Regime-specific thresholds
  regime:
    trend: 
      min_score: 0.50  # Minimum score for trend regime
      min_rr: 1.4      # Minimum risk-reward ratio for trend regime
    range:
      min_score: 0.48  # Minimum score for range regime
      min_rr: 1.2      # Minimum risk-reward ratio for range regime

# Portfolio Management
portfolio:
  # Portfolio constraints
  max_positions: 5
  min_position_weight: 0.02  # 2% minimum
  max_position_weight: 0.25  # 25% maximum
  target_volatility: 0.12  # 12% target volatility
  risk_aversion: 1.5
  correlation_penalty: 0.3
  expected_return_boost: 1.1
  
  # Correlation and exposure guardrails
  max_correlation: 0.6  # 60% maximum correlation between positions
  max_portfolio_risk: 0.03  # 3% maximum portfolio risk budget
  
  # Sector caps (percentage of max positions allowed per sector)
  sector_caps:
    "layer1": 0.4  # Max 40% of positions can be layer 1 blockchains
    "defi": 0.3    # Max 30% of positions can be DeFi tokens
    "meme": 0.2    # Max 20% of positions can be meme coins
    "stablecoin": 0.1  # Max 10% of positions can be stablecoins
  
  # Asset to sector mapping
  asset_sectors:
    "BTC/USDT": "layer1"
    "ETH/USDT": "layer1"

    "ADA/USDT": "layer1"
    "SOL/USDT": "layer1"
    "DOT/USDT": "layer1"
    "AVAX/USDT": "layer1"
    "MATIC/USDT": "layer1"
    "LINK/USDT": "defi"
    "UNI/USDT": "defi"
    "AAVE/USDT": "defi"
    "COMP/USDT": "defi"
    "SUSHI/USDT": "defi"
    "DOGE/USDT": "meme"
    "SHIB/USDT": "meme"
    "PEPE/USDT": "meme"
    "USDT/USD": "stablecoin"
    "USDC/USD": "stablecoin"
    "DAI/USD": "stablecoin"

  rebalancing:
    enabled: true
    interval: 3600  # 1 hour
    threshold: 0.05  # 5% deviation threshold

  diversification:
    enabled: true
    max_correlation: 0.7
    sector_allocation:
      crypto: 0.8
      stablecoins: 0.2

  performance_tracking:
    enabled: true
    metrics:
      - "sharpe_ratio"
      - "sortino_ratio"
      - "calmar_ratio"
      - "max_drawdown"
      - "win_rate"
      - "profit_factor"


# State Persistence Configuration
state:
  db_path: "trading_state.db"
  backup_enabled: true
  backup_interval: 3600  # 1 hour in seconds

# Logging Configuration
logging:
  level: "INFO"
  file: "logs/crypto_mvp.log"
  rotation: "1 week"
  retention: "1 month"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # Logging modules
  modules:
    trading: "INFO"
    risk: "INFO"
    execution: "INFO"
    data: "WARNING"
    strategies: "INFO"
    portfolio: "INFO"

  # Performance logging
  performance:
    enabled: true
    file: "logs/performance.log"
    rotation: "1 day"
    metrics:
      - "trades"
      - "profits"
      - "drawdowns"
      - "signals"
  
  # SL/TP logging configuration
  sl_tp_line: true  # Enable detailed SL/TP source logging

# Database Configuration
database:
  type: "sqlite"  # sqlite, postgresql, mysql
  url: "sqlite:///crypto_mvp.db"
  pool_size: 10
  max_overflow: 20
  echo: false

  # Tables
  tables:
    trades: true
    signals: true
    performance: true
    logs: true

# Redis Configuration (for caching)
redis:
  enabled: true
  host: "localhost"
  port: 6379
  db: 0
  password: null
  timeout: 5

  # Cache settings
  cache:
    market_data: 60  # seconds
    indicators: 300  # 5 minutes
    sentiment: 600  # 10 minutes
    on_chain: 1800  # 30 minutes

# Monitoring and Alerts
monitoring:
  enabled: true
  health_check_interval: 300  # 5 minutes

  # Alerts
  alerts:
    email:
      enabled: false
      smtp_server: "smtp.gmail.com"
      smtp_port: 587
      username: "your_email@gmail.com"
      password: "your_app_password"
      recipients:
        - "admin@example.com"

    telegram:
      enabled: false
      bot_token: "your_telegram_bot_token"
      chat_id: "your_chat_id"

    discord:
      enabled: false
      webhook_url: "your_discord_webhook_url"

  # Alert conditions
  conditions:
    max_drawdown_exceeded: true
    daily_loss_limit_exceeded: true
    connection_lost: true
    strategy_error: true
    execution_failed: true

# Profit Realization Configuration
realization:
  enabled: "${REALIZATION_ENABLED:-true}"  # Feature flag - enabled by default for production (overridable via REALIZATION_ENABLED env var)
  
  # Take profit ladder configuration
  take_profit_ladder:
    - r: 0.5    # At 0.5R profit
      pct: 0.25 # Sell 25% of position
    - r: 1.0    # At 1.0R profit  
      pct: 0.35 # Sell 35% of remaining position
    - r: 2.0    # At 2.0R profit
      pct: 0.30 # Sell 30% of remaining position
  
  # Trailing stop configuration
  trail:
    type: "chandelier"      # Trailing stop type
    n: 22                   # Lookback period for chandelier
    atr_mult_normal: 2.0    # ATR multiplier for normal volatility
    atr_mult_high_vol: 2.5  # ATR multiplier for high volatility
  
  # Time stop configuration
  time_stop_hours: 24  # Exit position after 24 hours if no TP/SL hit

# Session Risk Management Configuration
session_risk:
  daily_profit_trail_pct: 0.5  # 0.5% daily profit trail
  daily_dd_halt_pct: 0.01      # 1% daily drawdown halt

# Equity Reconciliation Configuration
equity:
  reconcile_tolerance: 0.0001  # 0.01% tolerance for equity reconciliation
  max_reconcile_iterations: 5  # Maximum iterations before hard stop

# Enhanced Execution Configuration
execution:
  # Existing execution config...
  order_type: "market"  # market, limit, stop
  slippage_tolerance: 0.001  # 0.1%
  max_retries: 3
  retry_delay: 5  # seconds
  timeout: 30  # seconds
  
  # New execution parameters
  maker_timeout_sec: 4      # Maker order timeout in seconds
  max_depth_pct: 0.2        # Maximum order book depth percentage
  
  # Strengthened sizing and slice configuration
  risk_per_trade_pct: 0.01       # Base risk (outside risk-on mode)
  per_symbol_cap_pct: 0.15       # Notional cap per symbol (15% of equity)
  session_cap_pct: 0.60          # Total deployment cap (60% of equity)
  min_slice_notional: 25         # Minimum slice size (bumped from $10)
  default_slice_notional: 50     # Typical slice size
  max_slices_per_order: 20       # Maximum slices per order
  
  # Edge after costs guard
  require_edge_after_costs: true  # Enable edge after costs guard
  min_edge_after_costs_bps: 10  # Minimum 10 bps edge after costs
  
  # Fee configuration (in basis points)
  maker_fee_bps: 10  # 0.1% maker fee
  taker_fee_bps: 20  # 0.2% taker fee (used for worst-case guard)
  
  # Post-only order routing
  post_only: true  # Use post-only limit orders at best bid/ask
  post_only_max_wait_seconds: 5  # Maximum wait time for maker fills
  allow_taker_fallback: false  # Do not convert to market orders if not filled

  # Order management
  order_management:
    enabled: true
    auto_cancel: true
    cancel_timeout: 300  # 5 minutes
    partial_fills: true

  # Slippage control
  slippage_control:
    enabled: true
    max_slippage: 0.002  # 0.2%
    dynamic_sizing: true

# Development and Testing
development:
  debug: false
  test_mode: true
  paper_trading: true
  simulation:
    enabled: true
    start_balance: 10000
    commission: 0.001  # 0.1%
    slippage: 0.0005  # 0.05%

  # Backtesting
  backtesting:
    enabled: true
    start_date: "2023-01-01"
    end_date: "2024-01-01"
    initial_balance: 10000
    commission: 0.001

# API Configuration
api:
  enabled: true
  host: "0.0.0.0"
  port: 8000
  debug: false

  # Authentication
  auth:
    enabled: false
    secret_key: "your_secret_key_here"
    token_expiry: 3600  # 1 hour

  # Rate limiting
  rate_limit:
    enabled: true
    requests_per_minute: 60
    burst_size: 10

# Environment Variables (will be replaced at runtime)
environment:
  # API Keys (set these in your .env file)
  BINANCE_API_KEY: "${BINANCE_API_KEY}"
  BINANCE_SECRET: "${BINANCE_SECRET}"
  COINBASE_API_KEY: "${COINBASE_API_KEY}"
  COINBASE_SECRET: "${COINBASE_SECRET}"
  TWITTER_API_KEY: "${TWITTER_API_KEY}"
  REDDIT_API_KEY: "${REDDIT_API_KEY}"
  NEWS_API_KEY: "${NEWS_API_KEY}"
  WHALE_ALERT_API_KEY: "${WHALE_ALERT_API_KEY}"
  GLASSNODE_API_KEY: "${GLASSNODE_API_KEY}"

  # Database
  DATABASE_URL: "${DATABASE_URL:-sqlite:///crypto_mvp.db}"

  # Redis
  REDIS_HOST: "${REDIS_HOST:-localhost}"
  REDIS_PORT: "${REDIS_PORT:-6379}"
  REDIS_PASSWORD: "${REDIS_PASSWORD:-}"

  # Logging
  LOG_LEVEL: "${LOG_LEVEL:-INFO}"
  LOG_FILE: "${LOG_FILE:-logs/crypto_mvp.log}"
